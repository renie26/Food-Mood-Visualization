<!DOCTYPE html>
<meta charset="utf-8">
<style>
body{
  background:#fafafa; 
  /*background:rgb(250,250,250);*/
}

.axis{
  stroke: #ddd;
  stroke-width: 1;
}

.arc text {
  font: 10px sans-serif;
  text-anchor: middle;
}

.line {
  fill: none;
  stroke-width: 2px;
}

  button {
    width: 4em;
    height: 1.5em;
    position: absolute;
    top: 695px;
    background: #bbb;
    color: white;
    font-size: 1em;
    padding-top: 0;
    margin-left: 5px;
    left: 290px;
  }

  #range {
    font: 15px sans-serif;
    margin-left: -10px;
    position: absolute;
    left: 250px;
    top: 695px;
  }

  input[type='range'] {
    -webkit-appearance: none !important;
    -webkit-border-radius: 5px;
    background-color: #bbb;
    height: 10px;
    width: 200px;
    position: absolute;
    top: 700px;
    left:20px;
  }

.tooltip{
  position: absolute;
  border-radius: 10px;
  text-align: center;
  background: #f1f1f1;
  border: #fdfdfd solid 1px;
  font-size: 10px;
  vertical-align: middle;
}

#legend{
  position:absolute;
  left: 0px;
  top: 310px;
}

.legend-icon{
  position:absolute;
  left: 0px;
  top: 0px;
  width: 10px;
  height: 30px;
  border-radius: 5px;
  border: #eee solid 1px;
}

.legend{
  position:absolute;
  left: 0px;
  top: 0px;
  width: 10px;
  height: 30px;
  border-radius: 5px;
  border: #eee solid 1px;
  display: none;
}

.legend1, .legend2, .legend3, .legend4, .legend5, .legend6, .legend7, .legend8{
  position:absolute;
  left: 0px;
  top: 0px;
  width: 10px;
  height: 30px;
  border-radius: 5px;
  border: #eee solid 1px;
  display: none;
}

</style>

  <input id="slider" type="range" min="1" max="46" value="1" step="1" />
  
  <span id="range">day 1</span>

  <button name="play" id="play">Play</button>

  <svg id="svg" width="1500" height="740">

  </svg>
  <div class="tooltip"></div>

  <div id="overlay2"></div>

  <div id="legend">
    <img class="legend-icon" src = "legend-icon.png" />
    <img class="legend" src = "legend.png" />
    <img class="legend1" src = "legend1.png" />
    <img class="legend2" src = "legend2.png" />
    <img class="legend3" src = "legend3.png" />
    <img class="legend4" src = "legend4.png" />
    <img class="legend5" src = "legend5.png" />
    <img class="legend6" src = "legend6.png" />
    <img class="legend7" src = "legend7.png" />
    <img class="legend8" src = "legend8.png" />
  </div>

<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

<script type='text/javascript' src ="js/textures.js"></script>

<script src="js/d3.v3.min.js"></script>
<script src="https://d3js.org/d3.v4.min.js"></script>

<script src="js/perlin.js"></script>
<!-- <script src="js/fisheye.js"></script> -->

<script>

  var svg = d3.selectAll("svg"),
      width = +svg.attr("width"),
      height = +svg.attr("height"),
      g = svg.append("g").attr("transform", "translate(" + 80 + "," + 140 + ")");

  //consecutive ones -> subtle difference
  var color_array = [];
  for (var j =1; j<=8; j++){
    var h = j/8 + 0.04; //0.75
    var s = 0.78;
    var i = 0.58;
    var rgb = hslToRgb(h,s,i);
    color_array[j-1] = rgbToHex(rgb[0],rgb[1],rgb[2]);
  }

  function componentToHex(c) {
    var hex = c.toString(16);
    return hex.length == 1 ? "0" + hex : hex;
  }
  function rgbToHex(r, g, b) {
    return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
  }
                                   
  function color(mood){
    return color_array[mood-1];
  }

  function randomcolor(mood,time){
    var s = 0.78*(1+time%3/30);
    var i = 0.58*(1+time%3/30);
    var rgb = hslToRgb(mood/8 + 0.04,s,i);
    var thiscolor = rgbToHex(rgb[0],rgb[1],rgb[2]);
    return thiscolor;
  }

  var x = d3.scale.linear()
      .range([55, 305]);

  var y = d3.scale.linear()
      .range([335,720]);

  var DURATION = 60000;

  var area_p = d3.svg.area()
    .interpolate("cardinal")
    .x(function(d) { return x(d.timestamp); })
    .y0(function(d) { return y(d.y0); })
    .y1(function(d) { return y(d.y0 + d.y); });

  var pie = d3.pie()
      .sort(null)
      .value(function(d) {
          return d.number;
       });

  var radius = 30;

  var path = d3.arc()
      .outerRadius(function(d){ 
        var this_radius = 5+Math.round(radius/48*Math.sqrt(d.data.calories));
        return this_radius;
      })
      .innerRadius(0);


  var tInit = performance.now();

  var t = new Date().getTime();
  var lt = t;
  var elapsedTime = 0;
  var elapsedTime2 = 0;

  requestAnimationFrame(animate);


  function animate () {
    t = new Date().getTime();
    var dt = t - lt;
    elapsedTime += dt / DURATION; 
    elapsedTime2 += dt / DURATION *10;
    lt = t;

    area_p = d3.svg.area()
    .interpolate("cardinal")
    .x(function(d) { return x(d.timestamp); })
    .y0(function(d,i) {return y(d.y0) 
      + noise.simplex2 ( (60-i) +elapsedTime2* 0.8, y(d.y0)+ elapsedTime2 * 0.5) 
      * Math.ceil(d.timestamp/10)*2;
    })
    .y1(function(d,i) { return y(d.y0 + d.y)
      + noise.simplex2 ( (60-i) +elapsedTime2* 0.8, y(d.y0 + d.y)+ elapsedTime2 * 0.5) 
      * Math.ceil(d.timestamp/10)*2+1;
    });

    //natural river movement along with time
    path = d3.arc()
      .outerRadius(function(d){
        var this_radius = 5+Math.round(radius/48*Math.sqrt(d.data.calories));
        if(d3.select(this).attr("id") == null)
          this_radius = this_radius+noise.simplex2(this_radius, this_radius*(d.data.calories%3+1+elapsedTime))*3;
        else
          this_radius = this_radius+noise.simplex2(this_radius, this_radius*(d.data.calories%3+1+elapsedTime*2))*6;
        return this_radius;
      })
      .innerRadius(0);

    // if(running)
    //   console.log(d3.selectAll("#overlay").attr("y"));

    requestAnimationFrame(animate);


    d3.selectAll(".layer")
    .attr("d",function(d){
        return area_p(d.values);
    });

    d3.selectAll(".texture-1").attr("d", path);
    d3.selectAll(".texture-2").attr("d", path);
    d3.selectAll(".texture-3").attr("d", path);
    d3.selectAll(".texture-4").attr("d", path);
    d3.selectAll(".texture-5").attr("d", path);
    d3.selectAll(".texture-6").attr("d", path);
    d3.selectAll(".texture-7").attr("d", path);
    d3.selectAll(".texture-8").attr("d", path);

  }

  function cal_X(timestamp){
    var tx = (width-20)/48 * timestamp-20;
    return tx;
  }

  function cal_Y(mood){
    var ty = mood*30-110;
    return ty;
  }

  var legendSelected =0;
  function drawEle(){

    // draw the lines
    for(var i=1; i<=8; i++){
      g.append("line")
        .attr("class","axis")
        .attr("id","line"+i)
        .attr("x1",-50)
        .attr("x2",1390)
        .attr("y1",function(){return 30*i-110;})
        .attr("y2",function(){return 30*i-110;});
    }

    d3.csv("data2.csv", function(d) {
      return d;
    }, function(error, data) {
      var timestamp = 0;
      var tx =0, ty =0;


    var range = data.map(function(d){ d.value = +d["Calories"]; return d; });

      for (var i=1; i<=data.length; i++){

        var data_temp = data[timestamp];

        var data_temp = data[timestamp];
        var data_pie=[
          {"mood":data_temp.mood,"calories":data_temp.Calories,"nutrition":"Carbs", "number":data_temp.Carbs, 
            "keyword": data_temp.Keyword, "timestamp":timestamp},
          {"mood":data_temp.mood,"calories":data_temp.Calories,"nutrition":"Fat", "number":data_temp.Fat,
            "keyword": data_temp.Keyword, "timestamp":timestamp},
          {"mood":data_temp.mood,"calories":data_temp.Calories,"nutrition":"Fiber", "number":data_temp.Fiber,
            "keyword": data_temp.Keyword, "timestamp":timestamp},
          {"mood":data_temp.mood,"calories":data_temp.Calories,"nutrition":"Protein", "number":data_temp.Protein,
            "keyword": data_temp.Keyword, "timestamp":timestamp},
          {"mood":data_temp.mood,"calories":data_temp.Calories,"nutrition":"Sodium", "number":data_temp.Sodium/1000,
            "keyword": data_temp.Keyword, "timestamp":timestamp}
        ];

        tx = cal_X(timestamp);
        ty = cal_Y(data_temp.mood);

        if (error) throw error;

        var arc = g.selectAll(".arc")
          .data(pie(data_pie))
          .enter().append("g")
            .attr("class", function(){return "arc"+timestamp;})
            .attr("transform", "translate(" + tx + "," + ty + ")")
            .on("mouseover", function(d){
              if(legendSelected!=0)
                hideThisLegend(legendSelected);
              showThisLegend(d.data.mood);
              legendSelected = d.data.mood;

              var transform = d3.select(this).attr("transform");

              drawTag(d.data,transform,data.length);
              var this_timestamp = this.className.baseVal.substring(3);
              drawThisRing(data[this_timestamp],transform,data.length);

              var stone = d3.transform(d3.select(this).attr("transform"));
              stone = stone.translate[0];
              var mood_stone = d.data.mood;

              for (var j=1; j<=data.length; j++){
                if(j==this_timestamp){
                  d3.selectAll(".arc"+j)
                      .transition()
                      .duration(1000)
                      .ease(d3.easePolyInOut)
                      .attr("transform",function(d){
                        var t = d3.transform(d3.select(this).attr("transform"));
                        return "translate(" +t.translate[0]+","+t.translate[1]+")";});
                  continue;
                }
                else{
                  d3.selectAll(".arc"+j)
                      .transition()
                      .duration(1000)
                      .ease(d3.easePolyInOut)
                      .attr("transform",function(d){
                        var t = d3.transform(d3.select(this).attr("transform"));
                        
                        if(Math.abs(mood_stone-d.data.mood)<4){
                          var scale = 360-Math.abs(mood_stone-d.data.mood)*40;
                          if(t.translate[0]<stone)
                            var newx = (width-scale)/47 * j-20;
                          else
                            var newx = (width-scale)/47 * j+scale/1.2;}
                        else
                          var newx = (width-20)/47 * j-20;
                        return "translate(" +newx+","+t.translate[1]+")";
                      });
                }
              }
            });

        // define the textures
        {
          var t1 = textures.lines().lighter().thicker();
          var t2 = textures.circles().lighter().thicker();
          var t3 = textures.paths().d("woven").lighter().thicker();
          var t4 = textures.paths().d("nylon").lighter();
          var t5 = textures.paths().d("hexagons").size(2).strokeWidth(1);
        }

        arc.append("path")
            .attr("class",function(d){return "texture-"+d.data.mood;})
            .attr("d", path)
            .attr("stroke", function(d) {
              return randomcolor(d.data.mood,timestamp)
            })
            .attr("fill", function(d) {
              return randomcolor(d.data.mood,timestamp)
            });

        timestamp ++;
      }

    });

  } 

  // smoothly pop up
  function drawTag(data, transform, _length){

      var keyword = data.keyword;
      var length = keyword.split("-").length;

      d3.selectAll(".tags").remove();
      d3.selectAll(".tagBg").remove();
      d3.selectAll(".tagimg").remove();

      svg.append("g")
        .append("circle")
        .attr("class","tagBg")
        .attr("cx",80)
        .attr("cy",140)
        .attr("transform", transform)
        .attr("r", 1)
        .attr("fill","#fcfcfc");

      d3.selectAll(".tagBg")
        .transition()
        .duration(700)
        .ease(d3.easeCubicInOut)
        .attr("r", 60);

        d3.selectAll(".tagBg")
        .on("click",function(){
          var time = data.timestamp+1;
          var status  = imageExists("lee-tag/"+time+".png");

          if(!status)
            return;

            svg.append("g")
            .append("svg:image")
            .attr('x',20)
            .attr('y',80)
            .attr("transform", transform)
            .attr('width', 120)
            .attr('height', 120)
            .attr("class", "tagimg")
            .attr("xlink:href","lee-tag/"+time+".png")
            .style("opacity",0)
            .on("click",function(){
              d3.selectAll(".tagimg")
              .transition()
              .duration(600)
              .ease(d3.easeCubicInOut)
              .style("opacity",0);
              d3.selectAll(".tagimg").transition().delay(700).remove();

            })
            .transition()
            .duration(700)
            .ease(d3.easeCubicInOut)
            .style("opacity",1);
        });


      for(var i = 0; i<length; i++){
        // alert(keyword.split("-")[i]);
        svg.append("g").append("text").attr("class","tags")
        .attr("x",function(){
          if(length<2)
            return 30;
          else 
            return 45-Math.pow(-1,i%2)*10;

        })
        .attr("y",function(){
          if(length<2)
            return 145;
          else if(length<5)
            return 120+i*15+Math.floor(i/2)*10;
          else
            return 110+i*15+Math.floor(i/2)*5;

        })
        .attr("transform", transform)
        .style("font-size","0.5px")//.attr("fill","#fff")
        .style("opacity",0)
        .attr("fill",function(){return color(data.mood);})
        .text(function(){return keyword.split("-")[i]});

        d3.selectAll(".tags")
        .transition()
        .delay(200)
        .duration(800)
        .ease(d3.easeCubicInOut)
        .style("font-size","14.5px").style("opacity",1);
      }
  }

  function drawThisRing(data_temp,transform,length){

    d3.selectAll(".ring_temp").remove();
    var Total = data_temp.Carbs*1+ data_temp.Fat*1+ data_temp.Fiber*1+ data_temp.Protein*1+ data_temp.Sodium/1000;
    var data_pie=[
      {"mood":data_temp.mood,"nutrition":"Carbs", "number":data_temp.Carbs,
        "percentage":(data_temp.Carbs/Total*100).toFixed(0) + '%'},
      {"mood":data_temp.mood,"nutrition":"Fat", "number":data_temp.Fat,
        "percentage":(data_temp.Fat/Total*100).toFixed(0) + '%'},
      {"mood":data_temp.mood,"nutrition":"Fiber", "number":data_temp.Fiber,
        "percentage":(data_temp.Fiber/Total*100).toFixed(0) + '%'},
      {"mood":data_temp.mood,"nutrition":"Protein", "number":data_temp.Protein,
        "percentage":(data_temp.Protein/Total*100).toFixed(0) + '%'},
      {"mood":data_temp.mood,"nutrition":"Sodium", "number":data_temp.Sodium/1000,
        "percentage":(data_temp.Sodium/Total/10).toFixed(0) + '%'}
    ];

    var path_ring = d3.arc()
        .outerRadius(2)
        .innerRadius(1);

    var ringThis = g.selectAll(".ring_temp")
      .data(pie(data_pie))
        .enter().append("g")
          .attr("class", "ring_temp")
          .attr("transform", transform);
    
    ringThis.append("path")
        .attr("class","ringpath")
        .attr("d", path_ring)
        .attr("stroke","#333")
        .attr("stroke-width", 1)
        .attr("stroke-opacity", 0)
        .attr("fill", function(d) {
          var _color = color(data_temp.mood);

        // define the textures
        {
          var t1 = textures.lines().lighter().thicker();
          var t2 = textures.circles().lighter().thicker();
          var t3 = textures.paths().d("woven").lighter().thicker();
          var t4 = textures.paths().d("nylon").lighter();
          var t5 = textures.paths().d("hexagons").size(2).strokeWidth(1);
        }

          switch(d.data.nutrition){

            case 'Carbs':
              t4.background(_color);
              svg.call(t4);
              return t4.url();
              break;

            case 'Fat':
              t5.background(_color);
              svg.call(t5);
              return t5.url();
              break;

            case 'Fiber':
              t1.background(_color);
              svg.call(t1);
              return t1.url();
              break;

            case 'Protein':
              t3.background(_color);
              svg.call(t3);
              return t3.url();
              break;

            case 'Sodium':
              t2.background(_color);
              svg.call(t2);
              return t2.url();
              break;
          }
        })
        .on("mouseover", function(d){
          var offsetX = 0;
          var offsetY = 0;
          if(d3.event.pageX - transform.split("(")[1].split(",")[0]<=90) offsetX = -110;
            else offsetX = 25;
          if(d3.event.pageY - transform.split(")")[0].split(",")[1]<=90) offsetY = -35;
            else offsetY = 10;

          // console.log(d.data);

          if(ringThis.selectAll("path").attr("stroke-opacity")>0.9){
            $(".tooltip").css("left", (d3.event.pageX+offsetX) + "px").css("top", (d3.event.pageY+offsetY)+"px")
            .css("height","25px").css("line-height","25px").css("width","85px").css("opacity",0);
            $( ".tooltip" ).text(d.data.nutrition + ": " +d.data.percentage)
            $( ".tooltip" ).animate({
                opacity: 1
              }, 500, function() {
                $(".tooltip").css("opacity",1);
            });
          }
        })
        .on("mouseout", function(d){

          var ra = Math.pow(Math.abs(d3.mouse(this)[0]),2);
          var rb = Math.pow(Math.abs(d3.mouse(this)[1]),2);
          var rc = Math.sqrt(ra+rb);
          if(rc>=90){
            // console.log(d.data.mood);
            hideThisLegend(d.data.mood);
            $( ".tooltip" ).animate({
                opacity: 0
              }, 500, function() {
              $( ".tooltip" ).text("");
              $(".tooltip").css("left", "0px").css("top", "0px").css("opacity",0)
              .css("height","0px").css("line-height","0px").css("width","0px");
            });
            $(".tooltip").delay(500).css("left", "0px").css("top", "0px").css("opacity",0)
              .css("height","0px").css("line-height","0px").css("width","0px").text("");

            path_ring = d3.arc()
            .outerRadius(0)
            .innerRadius(0);

            ringThis.selectAll("path")
            .transition().delay(200)
            .duration(800)
            .ease(d3.easeCubicInOut)
            .attr("d", path_ring)
            .attr("stroke-opacity", function(){
              return 0;});
            d3.selectAll(".ring_temp").transition().delay(1300).remove();


            d3.selectAll(".tagimg")
              .transition()
              .duration(400)
              .ease(d3.easeCubicOut)
              .style("opacity",0);
            d3.selectAll(".tagimg").transition().delay(700).remove();

            d3.selectAll(".tags")
            .transition()
            .duration(500)
            .ease(d3.easeCubicInOut)
            .style("font-size","0.5px").style("opacity",0);
            d3.selectAll(".tags").transition().delay(700).remove();

            d3.selectAll(".tagBg")
              .transition()
              .delay(100)
              .duration(300)
              .ease(d3.easeCubicInOut)
              .attr("r", 0).style("opacity",0);
            d3.selectAll(".tagBg").transition().delay(900).remove();

            for (var j=0; j<length; j++){
              d3.selectAll(".arc"+j)
                  .transition()
                  .duration(1000)
                  .ease(d3.easePolyInOut)
                  .attr("transform",function(d){
                    var t = d3.transform(d3.select(this).attr("transform"));
                    var newx = (width-20)/47 * j-20;
                    return "translate(" +newx+","+t.translate[1]+")";
                  });
            }
          }
        });



    path_ring = d3.arc()
        .outerRadius(90)
        .innerRadius(60);

    ringThis.selectAll("path")
        .transition()
        .duration(700)
        .ease(d3.easeCubicInOut)
        .attr("d", path_ring)
        .attr("stroke-opacity", 1);
  }

function chart(csvpath) {

  var strokecolor = color_array[0];

  var stack = d3.layout.stack()
      .offset("wiggle")
      .values(function(d) { return d.values; })
      .x(function(d) { return d.timestamp; })
      .y(function(d) { return d.value; });

  var nest = d3.nest()
      .key(function(d) { return d.mood; });

  var area = d3.svg.area()
      .interpolate("cardinal")
      .x(function(d) { return x(d.timestamp); })
      .y0(function(d) { return y(d.y0); })
      .y1(function(d) { return y(d.y0 + d.y); });

  var graph = d3.csv(csvpath, function(data) {
    data.forEach(function(d) {
      d.timestamp = d.timestamp;
        d.value = +d.Calories;
    });

    var layers = stack(nest.entries(data));

    x.domain(d3.extent(data, function(d) { return d.timestamp; }));
    y.domain([0, d3.max(data, function(d) { return d.y0 + d.y; })]);    

    svg.selectAll(".layer")
        .data(layers)
      .enter().append("path")
        .attr("class", "layer")
        .attr("d", function(d) { return area(d.values); })
        .style("fill", function(d) {return color(d.key); })
        .on("mouseover",function(d){
          if(legendSelected!=0)
            hideThisLegend(legendSelected);
          showThisLegend(d.key);
          legendSelected = d.key;

          d3.selectAll(".ring_temp").remove();
          d3.selectAll(".tags").remove();
          d3.selectAll(".tagimg").remove();
          d3.selectAll(".tagBg").remove();

          d3.select(this)
          .transition()
          .duration(300)
          .attr("stroke","#fff");

          d3.selectAll(".layer")
          .transition()
          .duration(300)
          .attr("opacity",0.9);

          d3.select(this)
          .transition()
          .duration(300)
          .attr("opacity",1);

            for (var j=0; j<length; j++){
              d3.selectAll(".arc"+j)
                  .transition()
                  .duration(1000)
                  .ease(d3.easePolyInOut)
                  .attr("transform",function(d){
                    var t = d3.transform(d3.select(this).attr("transform"));
                    var newx = (width-20)/47 * j-20;
                    return "translate(" +newx+","+t.translate[1]+")";
                  });
            }

          d3.selectAll(".texture-"+d.key)
          .transition()
          .duration(300)
          .attr("stroke","#222")
          .attr("id","selected")
          .attr("fill", function(d) {
            // define the textures
          {
            var t1 = textures.lines().lighter().thicker();
            var t2 = textures.circles().lighter().thicker();
            var t3 = textures.paths().d("woven").lighter().thicker();
            var t4 = textures.paths().d("nylon").lighter();
            var t5 = textures.paths().d("hexagons").size(2).strokeWidth(1);
          }

            var _color = color(d.data.mood);

            switch(d.data.nutrition){
              case 'Carbs':
                t4.background(_color);
                svg.call(t4);
                return t4.url();
                break;

              case 'Fat':
                t5.background(_color);
                svg.call(t5);
                return t5.url();
                break;

              case 'Fiber':
                t1.background(_color);
                svg.call(t1);
                return t1.url();
                break;

              case 'Protein':
                t3.background(_color);
                svg.call(t3);
                return t3.url();
                break;

              case 'Sodium':
                t2.background(_color);
                svg.call(t2);
                return t2.url();
                break;
            }
          });
        })
        .on("mouseout",function(d){

          hideThisLegend(d.key);
          d3.select(this)
          .transition()
          .duration(300)
          .attr("stroke","none");

          d3.selectAll(".layer")
          .transition()
          .duration(300)
          .attr("opacity",1);

          d3.selectAll("#selected")
          .transition()
          .duration(300)
          .attr("id",null)
          .attr("stroke",function(d) {
              return color(d.data.mood);
          })
          .attr("fill", function(d) {
              return color(d.data.mood);
          });
        });

    svg.selectAll(".layer")
      .transition()
      .duration(300)
      .attr("opacity", 1);
  });
}

  chart("data3_sum.csv");
  drawEle();

  //timeline animation
  {
    var running = false;
    var timer;
    
    $("button").on("click", function() {

      var duration = 180,
        maxstep = 46,
        minstep = 1;
      
      if (running == true) {
      
        $("button").html("Play");
        running = false;
        clearInterval(timer);
        
      }
      else if (running == false) {

            $("button").html("Pause");
            
            sliderValue = $("#slider").val();

            if($("overlay")!=null)
              d3.selectAll("#overlay").remove();

            d3.select("svg").append("g")
                .append("rect")
                .attr("id","overlay")
                .attr("x", function(){return 55;})
                .attr("y", 325)
                .attr("width", function(){return 1460;})
                .attr("height", 405)
                .attr("fill", "#fafafa")
                .transition()
                .duration(8100)
                .ease(d3.easeLinear) 
                .attr("x", 1460)
                .attr("width", 10);

            for(var i = sliderValue; i<=46; i++)
              d3.selectAll(".arc"+i)
              .transition()
              .duration(150)
              .style("opacity",0);

            timer = setInterval( function(){
                if (sliderValue < maxstep){
                  sliderValue++;
                  $("#slider").val(sliderValue);
                  $('#range').html("day "+sliderValue);
                  update(sliderValue);
                }
                else{
                  d3.selectAll("#overlay").remove();
                  $("button").html("Play");
                  running = false;
                  clearInterval(timer);
                  sliderValue =1;
                  $("#slider").val(sliderValue);
                  $('#range').html("day "+sliderValue);
                }
              
            }, duration);
            running = true;
      }
    });
    $("#slider").on("change", function(){ 

      sliderValue = $("#slider").val();

      running = false;
      update(sliderValue);
      $("#range").html("day "+sliderValue);
      clearInterval(timer);
      $("button").html("Play");

    });

    function update(timestamp) {
        for(var i=1; i<=timestamp; i++)
          d3.selectAll(".arc"+i)
            .transition()
            .duration(150)
            .style("opacity",1);

        d3.selectAll(".arc"+timestamp)
          .transition()
          .duration(150)
          .style("opacity",1);    
    }
  }


function hslToRgb ( h, s, l ){
    
    var r, g, b;

    if ( s == 0 ){

        r = g = b = l; // achromatic

    } else {

        var hue2rgb = function hue2rgb ( p, q, t ){

            if ( t < 0 ) t += 1;
            if ( t > 1 ) t -= 1;
            if ( t < 1/6 ) return p + ( q - p ) * 6 * t;
            if ( t < 1/2 ) return q;
            if ( t < 2/3 ) return p + ( q - p ) * ( 2/3 - t ) * 6;
            return p;

        }

        var q = l < 0.5 ? l * ( 1 + s ) : l + s - l * s;
        var p = 2 * l - q;

        r = Math.round(hue2rgb ( p, q, h + 1/3 ) *255);
        g = Math.round(hue2rgb ( p, q, h )*255);
        b = Math.round(hue2rgb ( p, q, h - 1/3 )*255);

    }

    return [  r,  g,  b ];

}

{
  $( ".legend-icon" ).mouseover(function() {
    $( ".legend" ).animate({
        display: "block",
        top: "-5px",
        left: "-5px",
        width: "300px",
        height: "250px"
      }, 700, function() {
        $(".legend").css("display","block").css("top","-5px").css("left","-5px");
    });
  });
  $( ".legend" ).mouseout(function() {
    $( ".legend" ).animate({
        width: "10px",
        height: "30px",
        top: "0px",
        left: "0px",
        display: "none"
      }, 700, function() {
        $(".legend").css("display","none").css("top","0px").css("left","0px");
    });
    // $(".legend").delay(2000).css("display","none").css("top","0px").css("left","0px");
  });
}


function showThisLegend(mood)
{  
    $( ".legend"+mood ).animate({
          display: "block",
          top: "-5px",
          left: "-5px",
          width: "300px",
          height: "35px",
          opacity: 1
        }, 500, function() {
          $(".legend"+mood).css("display","block").css("top","-5px").css("left","-5px");
      });
}

function hideThisLegend(mood)
{
  for(var i =1; i<9; i++)
    if(i!=mood)
      $(".legend"+i).css("display","none").css("top","0px").css("left","0px");

  $( ".legend"+mood).animate({
        display: "none",
        top: "0px",
        left: "0px",
        width: "10px",
        height: "30px",
        opacity: 0
      }, 300, function() {
        $(".legend"+mood).css("display","none").css("top","0px").css("left","0px");
        legendSelected = 0;
    });
}

function imageExists(image_url){

    var http = new XMLHttpRequest();

    http.open('HEAD', image_url, false);
    http.send();

    return http.status != 404;
}

</script>